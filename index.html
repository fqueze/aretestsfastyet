<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPCShell Test Performance Visualization</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-group {
            display: inline-flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #f0f0f0;
        }
        button.active {
            background: #0060df;
            color: white;
            border-color: #0060df;
        }
        .platform-links a {
            color: #0060df;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .platform-links a:hover {
            background: #f0f8ff;
            text-decoration: underline;
        }
        .charts-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 800px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        /* Make data points appear clickable */
        .plot .plotly .scatterlayer .trace .points path {
            cursor: pointer !important;
        }
        /* Style Plotly tooltips */
        .hoverlayer .hovertext {
            pointer-events: none !important;
        }
        .hoverlayer .hovertext path {
            fill: #2a2a2a !important;
            stroke: #2a2a2a !important;
            opacity: 0.95 !important;
        }
        .hoverlayer .hovertext text {
            fill: white !important;
            font-size: 14px !important;
            font-weight: 400 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>XPCShell Test Performance Visualization</h1>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 30px;">
                <div class="btn-group">
                    <button id="autoland-btn" class="active" onclick="switchRepository('autoland')">Autoland</button>
                    <button id="mozilla-central-btn" onclick="switchRepository('mozilla-central')">Mozilla Central</button>
                </div>

                <div class="platform-links" style="display: flex; align-items: center;">
                    <span style="margin-right: 15px; color: #666;">Jump to:</span>
                    <a href="#" onclick="jumpToPlatform('android'); return false;" style="margin-right: 15px;">Android</a>
                    <a href="#" onclick="jumpToPlatform('linux'); return false;" style="margin-right: 15px;">Linux</a>
                    <a href="#" onclick="jumpToPlatform('windows'); return false;" style="margin-right: 15px;">Windows</a>
                    <a href="#" onclick="jumpToPlatform('mac'); return false;">macOS</a>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="charts" class="charts-grid"></div>
    </div>

    <script>
        let allData = null;
        let currentRepository = 'autoland';

        const platforms = {
            'android': 'Android',
            'linux': 'Linux',
            'windows': 'Windows',
            'mac': 'macOS'
        };

        const colors = {
            'debug': '#ff6b6b',
            'opt': '#4ecdc4',
            'condprof': '#ffa500'
        };

        async function fetchData() {
            try {
                const response = await fetch('https://sql.telemetry.mozilla.org/api/queries/110630/results.json?api_key=Pyybfsna2r5KQkwYgSk9zqbYfc6Dv0rhxL99DFi1');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                // Process the data to extract platform and build type from the name field
                const processedData = result.query_result.data.rows.map(row => {
                    // Extract platform from name like "test-linux2404-64-shippable/opt-xpcshell-condprof-5"
                    let platform = 'unknown';
                    const platformMatch = row.name.match(/test-([^-]+)/);
                    if (platformMatch) {
                        const rawPlatform = platformMatch[1];
                        if (rawPlatform.includes('android')) platform = 'android';
                        else if (rawPlatform.includes('linux')) platform = 'linux';
                        else if (rawPlatform.includes('windows')) platform = 'windows';
                        else if (rawPlatform.includes('macos')) platform = 'mac';
                    }

                    // Extract build type from name (opt or debug) and check for condprof
                    const isDebug = row.name.includes('/debug-');
                    const isCondprof = row.name.includes('-condprof');
                    let buildType;
                    if (isCondprof) {
                        buildType = 'condprof';
                    } else if (isDebug) {
                        buildType = 'debug';
                    } else {
                        buildType = 'opt';
                    }

                    // Extract suite from name (part after the last slash and before any numbers)
                    const suite = row.name.split('/').pop().replace(/-\d+$/, '');

                    return {
                        ...row,
                        platform: platform,
                        build_type: buildType,
                        suite: suite,
                        date: row.start_time,
                        duration_seconds: row.time_seconds,
                        task_id: row.task_id,
                        retry_id: row.retry_id,
                        name: row.name
                    };
                });

                return processedData;
            } catch (error) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
                document.getElementById('loading').style.display = 'none';
                throw error;
            }
        }

        function createProfileUrl(taskId, retryId, jobName) {
            const baseUrl = `https://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/${taskId}/runs/${retryId}/artifacts/public/test_info/profile_resource-usage.json`;
            const encodedUrl = encodeURIComponent(baseUrl);
            const profileName = `${jobName} (${taskId}.${retryId})`;
            const encodedName = encodeURIComponent(profileName);
            return `https://profiler.firefox.com/from-url/${encodedUrl}?profileName=${encodedName}`;
        }

        function createScatterPlot(platformData, platform) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            container.id = `chart-${platform}`;

            // Add anchor for direct linking
            const anchor = document.createElement('a');
            anchor.id = `${currentRepository}:${platform}`;
            anchor.style.display = 'block';
            anchor.style.position = 'relative';
            anchor.style.top = '-80px'; // Offset for header
            container.appendChild(anchor);

            const traces = [];
            const buildTypes = ['debug', 'opt', 'condprof'];

            buildTypes.forEach(buildType => {
                const filteredData = platformData.filter(d => d.build_type === buildType);
                if (filteredData.length === 0) return;

                const trace = {
                    x: filteredData.map(d => new Date(d.date)),
                    y: filteredData.map(d => d.duration_seconds / 60), // Convert to minutes
                    mode: 'markers',
                    type: 'scatter',
                    name: buildType.toUpperCase().replace('-', ' '),
                    marker: {
                        color: colors[buildType],
                        size: 8,
                        opacity: 0.7
                    },
                    customdata: filteredData.map(d => {
                        // Format duration for tooltip
                        const totalSeconds = d.duration_seconds;
                        let durationStr;
                        if (totalSeconds >= 3600) {
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            durationStr = `${hours}h ${minutes}m`;
                        } else {
                            const minutes = Math.floor(totalSeconds / 60);
                            const seconds = Math.floor(totalSeconds % 60);
                            durationStr = `${minutes}m ${seconds}s`;
                        }

                        return {
                            name: d.name,
                            suite: d.suite,
                            taskId: d.task_id,
                            retryId: d.retry_id,
                            buildType: d.build_type,
                            duration: d.duration_seconds,
                            durationStr: durationStr,
                            date: d.date
                        };
                    }),
                    hovertemplate: '<b>%{customdata.name}</b><br>' +
                                   'Duration: %{customdata.durationStr}<br>' +
                                   'Date: %{x|%Y-%m-%d %H:%M}<br>' +
                                   'Build: %{customdata.buildType}<br>' +
                                   '<i>Click to view profile</i><br>' +
                                   '<extra></extra>'
                };
                traces.push(trace);
            });

            const layout = {
                title: `${platforms[platform]} - ${currentRepository}`,
                xaxis: {
                    title: 'Date',
                    type: 'date',
                    tickformat: '%Y-%m-%d'
                },
                yaxis: {
                    title: 'Duration (minutes)',
                    rangemode: 'tozero'
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 1,
                    y: 1,
                    xanchor: 'right',
                    bgcolor: 'rgba(255,255,255,0.9)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                hoverlabel: {
                    bgcolor: '#2a2a2a',
                    bordercolor: '#2a2a2a',
                    font: {
                        size: 15,
                        color: 'white',
                        family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif'
                    }
                },
                margin: {
                    l: 60,
                    r: 40,
                    t: 60,
                    b: 60
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: `test-performance-${platform}-${currentRepository}`,
                    height: 600,
                    width: 800,
                    scale: 1
                }
            };

            document.getElementById('charts').appendChild(container);
            Plotly.newPlot(container.id, traces, layout, config);

            // Add click handler for data points to open profile
            document.getElementById(container.id).on('plotly_click', function(data) {
                if (data.points.length > 0) {
                    const { customdata } = data.points[0];
                    const { taskId, retryId, name } = customdata;
                    openProfile(taskId, retryId, name);
                }
            });
        }

        function renderCharts() {
            document.getElementById('charts').innerHTML = '';

            if (!allData) return;

            const filteredData = allData.filter(d => d.repository === currentRepository);

            Object.keys(platforms).forEach(platform => {
                const platformData = filteredData.filter(d => d.platform === platform);
                if (platformData.length > 0) {
                    createScatterPlot(platformData, platform);
                }
            });

            document.getElementById('loading').style.display = 'none';
        }

        function switchRepository(repo, updateHash = true) {
            currentRepository = repo;

            document.getElementById('autoland-btn').classList.toggle('active', repo === 'autoland');
            document.getElementById('mozilla-central-btn').classList.toggle('active', repo === 'mozilla-central');

            renderCharts();

            // Update URL hash
            if (updateHash) {
                const hash = window.location.hash.split('#')[1] || '';
                const platform = hash.split(':')[1] || '';
                window.location.hash = platform ? `${repo}:${platform}` : repo;
            }
        }

        function openProfile(taskId, retryId, jobName) {
            const url = createProfileUrl(taskId, retryId, jobName);
            console.log('Opening profiler URL:', url);
            window.open(url, '_blank');
        }

        function jumpToPlatform(platform) {
            const targetId = `${currentRepository}:${platform}`;
            window.location.hash = targetId;
            const element = document.getElementById(targetId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        async function initialize() {
            try {
                // Parse hash to get initial repository and platform
                const hash = window.location.hash.substring(1);
                if (hash) {
                    const [repo, platform] = hash.split(':');
                    if (repo === 'autoland' || repo === 'mozilla-central') {
                        currentRepository = repo;
                        document.getElementById('autoland-btn').classList.toggle('active', repo === 'autoland');
                        document.getElementById('mozilla-central-btn').classList.toggle('active', repo === 'mozilla-central');
                    }
                }

                allData = await fetchData();
                renderCharts();

                // Scroll to specific platform if specified in hash
                if (hash) {
                    const [, platform] = hash.split(':');
                    if (platform) {
                        setTimeout(() => {
                            const element = document.getElementById(hash);
                            if (element) {
                                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        }

        // Handle hash changes (back/forward navigation)
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const [repo, platform] = hash.split(':');
                if (repo && (repo === 'autoland' || repo === 'mozilla-central')) {
                    if (repo !== currentRepository) {
                        switchRepository(repo, false);
                    }
                    if (platform) {
                        const element = document.getElementById(hash);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }
            }
        });

        initialize();

        // Handle window resize to make charts responsive
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Resize all Plotly charts
                const chartContainers = document.querySelectorAll('.chart-container');
                chartContainers.forEach(container => {
                    if (container.id) {
                        Plotly.Plots.resize(container.id);
                    }
                });
            }, 250); // Debounce resize events
        });
    </script>
</body>
</html>
