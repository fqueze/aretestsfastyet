<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPCShell Test Performance Visualization</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="shared.js"></script>
    <link rel="stylesheet" href="shared.css">
</head>
<body>
    <div class="container">
        <h1>XPCShell Test Performance Visualization</h1>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 30px;">
                <div class="btn-group">
                    <button id="autoland-btn" class="active" onclick="switchRepository('autoland')">Autoland</button>
                    <button id="mozilla-central-btn" onclick="switchRepository('mozilla-central')">Mozilla Central</button>
                </div>

                <div class="platform-links" style="display: flex; align-items: center;">
                    <span style="margin-right: 15px; color: #666;">Jump to:</span>
                    <a id="android-link" href="#autoland-android-tests" style="margin-right: 15px;">Android</a>
                    <a id="linux-link" href="#autoland-linux-tests" style="margin-right: 15px;">Linux</a>
                    <a id="windows-link" href="#autoland-windows-tests" style="margin-right: 15px;">Windows</a>
                    <a id="mac-link" href="#autoland-mac-tests">macOS</a>
                </div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="charts" class="charts-grid">
            <div class="charts-section">
                <h2 id="autoland-android-tests">Android Tests</h2>
                <div class="chart-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="charts-section">
                <h2 id="autoland-linux-tests">Linux Tests</h2>
                <div class="chart-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="charts-section">
                <h2 id="autoland-windows-tests">Windows Tests</h2>
                <div class="chart-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            <div class="charts-section">
                <h2 id="autoland-mac-tests">macOS Tests</h2>
                <div class="chart-container">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = null;
        let currentRepository = 'autoland';

        const colors = {
            'debug': '#ff6b6b',
            'opt': '#4ecdc4',
            'asan': '#9467bd',
            'tsan': '#8c564b',
            'ccov': '#e377c2',
            'msix': '#17becf',
            'condprof': '#ffa500',
            'debug-isolated-process': '#ffa500'
        };

        async function fetchData() {
            try {
                const response = await fetch('https://sql.telemetry.mozilla.org/api/queries/110630/results.json?api_key=Pyybfsna2r5KQkwYgSk9zqbYfc6Dv0rhxL99DFi1');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                // Process the data to extract platform and build type from the name field
                const processedData = result.query_result.data.rows.map(row => {
                    // Extract platform from name
                    const platform = extractPlatform(row.name);

                    // Extract build type from name (opt or debug) and check for special variants
                    const isDebug = row.name.includes('/debug-');
                    const isAsan = row.name.includes('-asan');
                    const isTsan = row.name.includes('-tsan');
                    const isCcov = row.name.includes('-ccov');
                    const isMsix = row.name.includes('-msix');
                    const isCondprof = row.name.includes('-condprof');
                    const isIsolatedProcess = row.name.includes('-isolated-process');
                    let buildType;
                    if (isAsan) {
                        buildType = 'asan';
                    } else if (isTsan) {
                        buildType = 'tsan';
                    } else if (isCcov) {
                        buildType = 'ccov';
                    } else if (isMsix) {
                        buildType = 'msix';
                    } else if (isCondprof) {
                        buildType = 'condprof';
                    } else if (isDebug && isIsolatedProcess) {
                        buildType = 'debug-isolated-process';
                    } else if (isDebug) {
                        buildType = 'debug';
                    } else {
                        buildType = 'opt';
                    }

                    // Extract suite from name (part after the last slash and before any numbers)
                    const suite = row.name.split('/').pop().replace(/-\d+$/, '');

                    return {
                        ...row,
                        platform: platform,
                        build_type: buildType,
                        suite: suite,
                        date: row.start_time,
                        duration_seconds: row.time_seconds,
                        task_id: row.task_id,
                        retry_id: row.retry_id,
                        name: row.name,
                        machine_name: row.machine_name
                    };
                });

                return processedData;
            } catch (error) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading data: ${error.message}`;
                throw error;
            }
        }


        function createTestScatterPlot(platformData, platform) {
            // Create section with header
            const section = document.createElement('div');
            section.className = 'charts-section';

            const header = document.createElement('h2');
            header.id = `${currentRepository}-${platform}-tests`;
            header.textContent = `${platforms[platform]} Tests`;
            header.style.cursor = 'pointer';
            section.appendChild(header);

            const container = document.createElement('div');
            container.className = 'chart-container';
            container.id = `chart-${platform}`;

            // Check if this chart is targeted by URL hash
            const hash = window.location.hash.substring(1);
            const isTargeted = hash === `${currentRepository}-${platform}-tests`;

            // Store platform data for lazy loading
            container.dataset.platform = platform;

            section.appendChild(container);
            document.getElementById('charts').appendChild(section);

            if (isTargeted) {
                // Load immediately for hash-targeted charts (after adding to DOM)
                console.log('Loading chart immediately for platform:', platform, 'container id:', container.id);
                const buildTypes = ['debug', 'opt', 'asan', 'tsan', 'ccov', 'msix', 'condprof', 'debug-isolated-process'];
                createScatterPlot(container, platformData, platform, currentRepository, colors, buildTypes);
                container.dataset.loaded = 'true';
            } else {
                // Add loading placeholder for lazy loading
                container.innerHTML = '<div class="loading">Loading...</div>';
                container.dataset.loaded = 'false';
            }
        }

        let chartObserver = null;

        function renderCharts() {
            document.getElementById('charts').innerHTML = '';

            // Disconnect existing observer
            if (chartObserver) {
                chartObserver.disconnect();
            }

            if (!allData) return;

            const filteredData = allData.filter(d => d.repository === currentRepository);

            // Store filtered data for lazy loading
            window.currentFilteredData = filteredData;

            Object.keys(platforms).forEach(platform => {
                const platformData = filteredData.filter(d => d.platform === platform);
                if (platformData.length > 0) {
                    createTestScatterPlot(platformData, platform);
                }
            });

            // Set up intersection observer for lazy loading
            setupChartObserver();
        }

        function setupChartObserver() {
            const chartContainers = document.querySelectorAll('.chart-container[data-loaded="false"]');

            if (chartContainers.length === 0) return;

            chartObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.target.dataset.loaded === 'false') {
                        loadChart(entry.target);
                    }
                });
            }, {
                rootMargin: '100px' // Start loading 100px before the chart comes into view
            });

            chartContainers.forEach(container => {
                chartObserver.observe(container);
            });
        }

        function loadChart(container) {
            const platform = container.dataset.platform;
            const platformData = window.currentFilteredData.filter(d => d.platform === platform);

            if (platformData.length > 0) {
                container.innerHTML = ''; // Remove loading placeholder
                const buildTypes = ['debug', 'opt', 'asan', 'tsan', 'ccov', 'msix', 'condprof', 'debug-isolated-process'];
                createScatterPlot(container, platformData, platform, currentRepository, colors, buildTypes);
                container.dataset.loaded = 'true';

                // Stop observing this container
                if (chartObserver) {
                    chartObserver.unobserve(container);
                }
            }
        }

        function switchRepository(repo, updateHash = true) {
            currentRepository = repo;

            document.getElementById('autoland-btn').classList.toggle('active', repo === 'autoland');
            document.getElementById('mozilla-central-btn').classList.toggle('active', repo === 'mozilla-central');

            // Update platform link targets
            ['android', 'linux', 'windows', 'mac'].forEach(platform => {
                document.getElementById(`${platform}-link`).href = `#${repo}-${platform}-tests`;
            });

            // Update placeholder IDs to match current repository
            ['android', 'linux', 'windows', 'mac'].forEach(platform => {
                const h2Element = document.querySelector(`h2[id$="-${platform}-tests"]`);
                if (h2Element) {
                    h2Element.id = `${repo}-${platform}-tests`;
                }
            });

            renderCharts();

            // Update URL hash
            if (updateHash) {
                const hash = window.location.hash.substring(1);
                if (hash && hash.endsWith('-tests')) {
                    // Extract platform from current hash
                    const withoutSuffix = hash.slice(0, -6);
                    let platform = '';
                    if (withoutSuffix.startsWith('autoland-')) {
                        platform = withoutSuffix.slice(9);
                    } else if (withoutSuffix.startsWith('mozilla-central-')) {
                        platform = withoutSuffix.slice(16);
                    }
                    window.location.hash = platform ? `${repo}-${platform}-tests` : '';
                } else {
                    window.location.hash = '';
                }
            }
        }


        async function initialize() {
            try {
                // Parse initial hash
                const { repository, platform } = parseInitialHash();
                currentRepository = repository;
                document.getElementById('autoland-btn').classList.toggle('active', repository === 'autoland');
                document.getElementById('mozilla-central-btn').classList.toggle('active', repository === 'mozilla-central');

                allData = await fetchData();
                renderCharts();

                // Scroll to specific platform if specified in hash
                if (platform) {
                    setTimeout(() => {
                        const element = document.getElementById(`${repository}-${platform}-tests`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        }

        // Setup event handlers
        handleHashChange((repo, updateHash) => switchRepository(repo, updateHash));
        setupWindowResize();

        // Add click handler for h2 headers to update URL hash
        document.addEventListener('click', function(event) {
            if (event.target.tagName === 'H2' && event.target.id) {
                window.location.hash = event.target.id;
            }
        });

        initialize();
    </script>
</body>
</html>
